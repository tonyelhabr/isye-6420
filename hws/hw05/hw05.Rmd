---
title: 'ISYE 6420: Homework 5'
author: 'aelhabr3'
output:
  html_document:
    css: ../styles_hw.css
    theme: cosmo
    highlight: haddock
    toc: false
---

```{r setup, include=F, cache=F}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(
  # rows.print = 25,
  # rows.print = 25,
  echo = TRUE,
  # cache = FALSE,
  cache = TRUE,
  include = TRUE,
  fig.show = 'asis',
  fig.align = 'center',
  fig.width = 8,
  # size = 'small',
  # fig.height = 5,
  # fig.width = 5,
  # out.width = 5,
  fig.asp = 0.75,
  warning = FALSE,
  message = FALSE
)
```

```{r postprocess, include=F, echo=F, cache=F}
.path_sans_ext <- file.path('hw05')
.path_rmd <- paste0(.path_sans_ext, '.Rmd')
# spelling::spell_check_files(.path_rmd)
```

```{r setup-1, include=F, echo=F, eval=T}
library(tidyverse)
format_num <- function(x, digits = 4) {
  fmt <- sprintf('%%.%df', digits)
  sprintf(fmt, x)
}
```

# 1. Cross-validating a Bayesian Regression.

## Instructions

<instructions>
In this excercise...
</instructions>


## Response

```{r setup-2}
library(tidyverse)
```

Below we create the data according to the instructions.

```{r q1-0}
setseed(42)
n <- 40
x1 <- runif(n)
x2 <- floor(10 * runif(n)) + 1
y <- 2 + 6 * x1 - 05 * x2 + rnorm(,n)
x1 <- round(x1, 4)
y <- round(y, 4)
x1
x2
y
```

```{r q1-0-clipr, include=F, echo=F, eval=F}
# .x1 %>% clipr::write_clip() %>% datapasta::vector_paste()
# .x2 %>% clipr::write_clip() %>% datapasta::vector_paste()
# .y %>% clipr::write_clip() %>% datapasta::vector_paste()
```

```{r q1-r2openbugs-1 include=F, echo=F, eval=F}
# NOTE: This isn't working for some reason (even when copy-pasting the above values)
# and trying `inits <- NULL`.
model <- function() {
  for(i in 1:k) {
    mu[i] <- beta0 + beta1 * x1[i] + beta2 * x2[i]
    y[i] ~ dnorm(mu[i],tau)
  }
  for(i in k+1:n) {
    ypred[i] <- beta0 + beta1 * x1[i] + beta2 * x2[i]
    error[i] <- ypred[i] - y[i]
    se[i] <- error[i] * error[i]
  }
  mse <- mean(se[k+1:n])
  beta0 ~ dnorm(0, 0.0001)
  beta1 ~ dnorm(0, 0.0001)
  beta2 ~ dnorm(0, 0.0001)
  tau ~ dgamma(0.001, 0.001)
  sigma <- 1 / sqrt(tau)
}
data <- list(
  n = .n,
  k = 0.5 * .n,
  x1 = .x1,
  x2 = .x2,
  y = .y
)
inits <- c(beta0 = 0, beta1 = 0, beta2 = 0, tau = 1)
params <- c('se', 'mse', 'error', paste0('beta', 0:2), 'sigma')
res_sim <-
  R2OpenBUGS::bugs(
    data = data,
    inits = inits,
    model.file = model,
    parameters.to.save = params,
    DIC = FALSE,
    debug = TRUE,
    n.chains = 4,
    n.iter = 10000,
    n.burnin = 1000
  )
res_sim$summary
```

```{r q2-a-2-hide, include=F, echo=F, eval=F}
clipr::write_clip(knitr::kable(res_sim$summary))
```

The OpenBUGS code looks as follows.

```
model{
for(i in 1:k) {
  mu[i] <- beta0 + beta1 * x1[i] + beta2 * x2[i]
  y[i] ~ dnorm(mu[i], tau)
}
for(i in k+1:n) {
  ypred[i] <- beta0 + beta1 * x1[i] + beta2 * x2[i]
  error[i] <- ypred[i] - y[i]
  se[i] <- error[i] * error[i]
}
  mse <- mean(se[k+1:n])
  beta0 ~ dnorm(0, 0.0001)
  beta1 ~ dnorm(0, 0.0001)
  beta2 ~ dnorm(0, 0.0001)
  tau ~ dgamma(0.001, 0.001)
  sigma <- 1 / sqrt(tau)
}

# data
list(
  n = 40, 
  k = 20,
  x1 = c(0.9148, 0.9371, 0.2861, 0.8304, 0.6417, 0.5191, 0.7366, 0.1347, 0.657, 0.7051, 0.4577, 0.7191, 0.9347, 0.2554, 0.4623, 0.94, 0.9782, 0.1175, 0.475, 0.5603, 0.904, 0.1387, 0.9889, 0.9467, 0.0824, 0.5142, 0.3902, 0.9057, 0.447, 0.836, 0.7376, 0.8111, 0.3881, 0.6852, 0.0039, 0.8329, 0.0073, 0.2077, 0.9066, 0.6118),
  x2 = c(4, 5, 1, 10, 5, 10, 9, 7, 10, 7, 4, 4, 4, 8, 1, 8, 7, 2, 3, 6, 7, 10, 8, 6, 9, 2, 3, 9, 7, 3, 1, 2, 3, 5, 2, 8, 1, 4, 6, 1),
  y = c(5.6948, 4.7614, 3.975, 1.256, 1.9822, 0.5474, 1.1081, 0.7521, 0.5105, 3.386, 3.0684, 3.5308, 7.1838, 0.1755, 4.3635, 3.9166, 5.0486, 1.7948, 0.3569, 2.6469, 3.557, -1.9825, 4.5152, 6.0797, -2.7327, 5.3878, 3.1771, 3.9729, 2.1025, 6.2369, 4.8825, 5.7761, 3.4522, 2.6575, 0.4809, 3.5785, 2.3122, 1.7097, 3.5538, 4.0709) 
)

# inits
list(beta0 = 0, beta1 = 0, beta2 = 0, tau = 1)
```

The results are as follows.

![](q1-te-output.png)

```{r q1-openbugs-output-1, echo=F, include=F, eval=F}
# NOTE: Use this as an alternative to the picture.
res_summ <-
  tibble(
    var = c('beta0', 'beta1', 'beta2', 'mse', 'sigma', 'tau'),
    mean = c(2.089, 5.591, -0.4721, 0.9194, 1.125, 0.8666),
    sd = c(0.7401, 1.005, 0.09454, 0.2793, 0.2077, 0.298),
    MC_error = c(0.00809, 0.009595, 0.000851, 0.002238, 0.000965, 0.001322),
    val2.5pc = c(0.6276, 3.593, -0.6607, 0.6327, 0.8057, 0.3847),
    median = c(2.093, 5.595, -0.4719, 0.8429, 1.096, 0.8331),
    val97.5pc = c(3.55, 7.567, -0.2854, 1.658, 1.612, 1.541),
    start = c(1001, 1001, 1001, 1001, 1001, 1001),
    sample = c(1e+05, 1e+05, 1e+05, 1e+05, 1e+05, 1e+05)
  ) %>% 
  rename(` ` = var)

res_summ %>% knitr::kable() %>% clipr::write_clip()
```

<hide>
|      |    mean|      sd| MC_error| val2.5pc|  median| val97.5pc| start| sample|
|:-----|-------:|-------:|--------:|--------:|-------:|---------:|-----:|------:|
|beta0 |  2.0890| 0.74010| 0.008090|   0.6276|  2.0930|    3.5500|  1001|  1e+05|
|beta1 |  5.5910| 1.00500| 0.009595|   3.5930|  5.5950|    7.5670|  1001|  1e+05|
|beta2 | -0.4721| 0.09454| 0.000851|  -0.6607| -0.4719|   -0.2854|  1001|  1e+05|
|mse   |  0.9194| 0.27930| 0.002238|   0.6327|  0.8429|    1.6580|  1001|  1e+05|
|sigma |  1.1250| 0.20770| 0.000965|   0.8057|  1.0960|    1.6120|  1001|  1e+05|
|tau   |  0.8666| 0.29800| 0.001322|   0.3847|  0.8331|    1.5410|  1001|  1e+05|
</hide>


## 3. Shocks.

## Instructions

<instructions>
An experiment was conducted...
</instructions>

## Response

Below is OpenBUGs code for this problem. Note that:

+ "noninformative priors" is implemented as `dnorm(0.0, 0.00001)`;
+ `pred1logit` is the untransformed prediction;
+ `pred1logitinv` is the transformed prediction (i.e. a value between 0 and 1);
+ `x` and `response` (in the data list) is supplied "explicitly" as vectors having `n` x length(`x`) values (i.e. 70 x 6 = 420 values). The values of `response` are inferred from the number of responses $y$ and number of trials $n$ from the provided table.

```
model{
  for(i in 1:n) {
    response[i] ~ dbern(p[i])
    logit(p[i]) <- beta0 + beta1 * x[i]
  }
  beta0 ~ dnorm(0.0, 0.00001)
  beta1 ~ dnorm(0.0, 0.00001)

  pred1logit <- beta0 + beta1 * (2.5)
  pred1logitinv <- 1 / (1 + exp(-pred1logit))
}

# data
list(
  n = 420,
  x = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5),
  response = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0)
)

# inits
list(beta0 = 0, beta1 = 0)
```

The results are as follows.

![](q3-output.png)

```{r q3-openbugs-output-1, echo=F, include=F, eval=F}
# NOTE: Use this as an alternative to the picture.
data.frame(stringsAsFactors=FALSE,
         var = c("beta0", "beta1", "pred1logit", "pred1logitinv"),
        mean = c(-3.337, 1.259, -0.1891, 0.4531),
          sd = c(0.3289, 0.1135, 0.1382, 0.03408),
    MC_error = c(0.00175, 0.000616, 0.00059, 0.000145),
    val2.5pc = c(-4.009, 1.05, -0.4637, 0.3861),
      median = c(-3.328, 1.256, -0.1885, 0.453),
   val97.5pc = c(-2.722, 1.491, 0.08033, 0.5201),
       start = c(1001, 1001, 1001, 1001),
      sample = c(1e+05, 1e+05, 1e+05, 1e+05)
)

res_summ <-
  tibble(
    var = c('beta0', 'beta1', 'pred1logit', 'pred1logitinv'),
    mean = c(-3.337, 1.259, -0.1891, 0.4531),
    sd = c(0.3289, 0.1135, 0.1382, 0.03408),
    MC_error = c(0.00175, 0.000616, 0.00059, 0.000145),
    val2.5pc = c(-4.009, 1.05, -0.4637, 0.3861),
    median = c(-3.328, 1.256, -0.1885, 0.453),
    val97.5pc = c(-2.722, 1.491, 0.08033, 0.5201),
    start = c(1001, 1001, 1001, 1001),
    sample = c(1e+05, 1e+05, 1e+05, 1e+05)
  ) %>% 
  rename(` ` = var)

res_summ %>% knitr::kable() %>% clipr::write_clip()
```

<hide>
|              |    mean|      sd| MC_error| val2.5pc|  median| val97.5pc| start| sample|
|:-------------|-------:|-------:|--------:|--------:|-------:|---------:|-----:|------:|
|beta0         | -3.3370| 0.32890| 0.001750|  -4.0090| -3.3280|  -2.72200|  1001|  1e+05|
|beta1         |  1.2590| 0.11350| 0.000616|   1.0500|  1.2560|   1.49100|  1001|  1e+05|
|pred1logit    | -0.1891| 0.13820| 0.000590|  -0.4637| -0.1885|   0.08033|  1001|  1e+05|
|pred1logitinv |  0.4531| 0.03408| 0.000145|   0.3861|  0.4530|   0.52010|  1001|  1e+05|

</hide>

### Aside

We can carry out the equivalent calculations using `R`.

```{r q3-r-setup-0}
.x <- 0:5
.y <- c(0, 9, 21, 47, 60, 63)
..n <- 70
.n <- rep(..n, length(.x))
.diff <- .n - .y
.diff
```

```{r q3-r-setup-1-hide, include=F, echo=F, eval=F}
data <-
  tibble(
    x = .x, 
    y = .y,
    n = .n,
    p = c(0.00, 0.129, 0.300, 0.671, 0.857, 0.900)
  ) %>% 
  mutate_at(vars(x, y, n), as.integer)
data
data %>% mutate(p_calc = y / n) %>% mutate(p_diff = p - p_calc)
```

```{r q3-r2openbugs}
ones <- .y %>% purrr::map(~rep(1L, .x))
zeros <- .diff %>% purrr::map(~rep(0L, .x))
data_explicit <-
  purrr::map2(ones, zeros, c) %>% 
  tibble(x = .x, response = .) %>% 
  unnest(response)
data_explicit
```

```{r q3-r2openbugs-copy, include=F, echo=F, eval=F}
data_explicit %>% pull(x) %>% as.numeric() %>% datapasta::vector_paste()
data_explicit %>% pull(response) %>% as.numeric() %>% datapasta::vector_paste()
```
```{r q3-r-glm-1, include=F, echo=F, eval=F}
fit_glm <- glm(formula(response ~ x), data = data_explicit, family = binomial())
fit_glm
data_new <- tibble(x = 2.5)
pred_glm_link <- predict(fit_glm, newdata = data_new, type = 'link')
pred_glm_link
pred_glm <- predict(fit_glm, newdata = data_new, type = 'response')
pred_glm
confint_pred_glm <- ciTools::add_ci(data_new, fit_glm)
confint_pred_glm
```

```{r q3-r-lm-1, include=F, echo=F, eval=F}
fit_lm <- lm(formula(p ~ x), data = data)
fit_lm
# confint_lm_x <- confint(fit_lm)
# confint_lm_x

pred_lm <- predict(fit_lm, newdata = data_new)
pred_lm
confint_pred_lm <- predict(fit_lm, newdata = data_new, interval = 'confidence', level = 0.95)
confint_pred_lm
```
