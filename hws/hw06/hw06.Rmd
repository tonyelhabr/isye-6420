---
title: 'ISYE 6420: Homework 6'
author: 'aelhabr3'
output:
  html_document:
    css: ../styles_hw.css
    theme: cosmo
    highlight: haddock
    toc: false
---

```{r setup, include=F, cache=F}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(
  # rows.print = 25,
  # rows.print = 25,
  echo = TRUE,
  cache = TRUE,
  # cache.lazy = FALSE,
  include = TRUE,
  fig.show = 'asis',
  fig.align = 'center',
  fig.width = 8,
  # size = 'small',
  # fig.height = 5,
  # fig.width = 5,
  # out.width = 5,
  fig.asp = 0.75,
  warning = FALSE,
  message = FALSE
)
options(width = 300)
```

```{r postprocess, include=F, echo=F, cache=F}
.path_sans_ext <- file.path('hw06')
.path_rmd <- paste0(.path_sans_ext, '.Rmd')
# spelling::spell_check_files(.path_rmd)
```

```{r setup-1, include=F, echo=F, eval=T}
library(tidyverse)
format_num <- function(x, digits = 4) {
  fmt <- sprintf('%%.%df', digits)
  sprintf(fmt, x)
}
```

# 1. Cancer of Tongue.

## Instructions

<instructions>
Sickle-Santanello et al (1988) provide data on 80 males diagnosed with cancer of the tongue. Data are provided in the file tongue.csv|dat|xlsx. The variables in the dataset are as follows:</br>
+ Tumor DNA profile (1 - aneuploid tumor, 2 - diploid tumor);</br>
+ Time to death or on-study time (in weeks); and</br>
+ Censoring indicator (0=observed, 1=censored)</br></br>
Fit the regression with tumor profile as covariate. What is the 95% Credible Set for the slope $\beta_1$?
</instructions>


## Response

```{r setup-2}
library(tidyverse)
```

```{r model_q1_ex, include=F, echo=F, eval=F}
model_q1_ex <- glue::glue_collapse('
  model
  {	
    for(i in 1 : N) {
      times[i] ~ dweib(v,lambda[i])I(censor[i],)
      lambda[i] <- exp(beta0 + beta1*type[i])
      S[i]  <- exp(-lambda[i]*pow(times[i],v));
      f[i]  <- lambda[i]*v*pow(times[i],v-1)*S[i]
      h[i] <- f[i]/S[i]
      index[i] <- i	#for plots
    }	
    beta0 ~ dnorm(0.0, 0.0001)
    beta1 ~ dnorm(0.0, 0.0001)
    v ~ dexp(0.001)
    
    # Median survival time 
    median0 <-  pow(log(2) * exp(-beta0), 1/v)
    median1 <-  pow(log(2) * exp(-beta0-beta1), 1/v)
  }
')

path_model_q1_ex <- 'model_q1_ex.txt'
write_lines(model_q1_ex, path_model_q1_ex)

data_list_q1_ex <-
  list(
    N = 90,
    type = c(
      1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0
    ),
    censor = c(
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0,  882,  892,  1031,  1033,  1306,  1335, 
      0,  1452,  1472,  0,  0,  0,  0, 
      0,  0,  0,  0,  0,  0,  0, 
      0,  0,  0,  0,  381,  0,  0, 
      0,  0,  0,  0,  0,  0,  0, 
      529,  0,  0,  0,  0,  0,  0, 
      0,  0,  0,  945,  0,  0,  1180, 
      0,  0,  1277,  1397,  1512,  1519
    ), 
    times = c(
      17,  42,  44,  48,  60,  72,  74, 
      95,  103,  108,  122,  144,  167,  170, 
      183,  185,  193,  195,  197,  208,  234, 
      235,  254,  307,  315,  401,  445,  464, 
      484,  528,  542,  567,  577,  580,  795, 
      855,  NA ,  NA,  NA,  NA,  NA,  NA, 
      1366,  NA,  NA,  1,  63,  105,  129, 
      182,  216 ,  250,  262,  301,  301,  342, 
      354,  356,  358,  380,  NA,  383,  383, 
      388,  394,  408,  460,  489,  499,  524, 
      NA,  535,  562,  675,  676,  748,  748, 
      778,  786,  797,  NA,  955,  968,  NA, 
      1245,  1271,  NA,  NA,  NA,  NA
    )
  )

inits_q1_ex <- function() {
  list(v = 1, beta0 = 0, beta1 = 0)
}

params_q1 <-
  c(
    paste0('beta', c('0', '1')),
    paste0('median', c('0', '1')),
    'v',
    'S',
    'f',
    'h'
  )
```

```{r res_sim_q1_ex, include=F, echo=F, eval=F}
# res_sim_q1_ex <-
#   R2OpenBUGS::bugs(
#     debug = TRUE,
#     data = data_list_q1_ex,
#     inits = inits_q1_ex,
#     model.file = path_model_q1_ex,
#     parameters.to.save = params_q1_ex,
#     DIC = FALSE,
#     n.chains = 1,
#     # n.iter = 50000,
#     n.iter = 5000,
#     n.burnin = 1000
#   )
```

```{r path_res_sim_q1, include=F, echo=F}
path_res_sim_q1 <- 'path_res_sim_q1.rds'
eval_model_q1 <- !fs::file_exists(path_res_sim_q1)
```

```{r model_q1, include=F, echo=F}
model_q1 <- glue::glue_collapse('
  model {	
    for(i in 1:n) {
      times[i] ~ dweib(v, lambda[i]) I(censor[i],)
      lambda[i] <- exp(beta0 + beta1 * type[i])
      S[i] <- exp(-lambda[i] * pow(times[i], v));
      f[i] <- lambda[i] * v * pow(times[i], v-1) * S[i]
      h[i] <- f[i] / S[i]
      index[i] <- i
    }	
    beta0 ~ dnorm(0.0, 0.0001)
    beta1 ~ dnorm(0.0, 0.0001)
    v ~ dexp(0.001)
    
    # Median survival time 
    median0 <- pow(log(2) * exp(-beta0), 1 / v)
    median1 <- pow(log(2) * exp(-beta0 - beta1), 1 / v)
  }
')

path_model_q1 <- 'model_q1.txt'
write_lines(model_q1, path_model_q1)
```

```{r data_list_q1, include=F, echo=F}
data_raw_q1 <- 
  'tongue.csv' %>% 
  read_csv(col_names = FALSE) %>% 
  set_names(c('type', 'times', 'censor'))

data_q1 <-
  data_raw_q1 %>% 
  mutate(idx = row_number()) %>% 
  group_by(type) %>% 
  mutate(idx_type = row_number(idx)) %>% 
  ungroup() %>% 
  select(idx, idx_type, everything()) %>% 
  # BUGs doesn't like integers.
  mutate_all(as.double) %>% 
  # Need to recode to be like "gastric.odc".
  mutate(dummy = times) %>% 
  mutate_at(vars(censor), ~ifelse(. == 0, ., dummy)) %>% 
  mutate_at(vars(times), ~ifelse(censor == 0, ., NA_real_)) %>% 
  select(-dummy)
data_q1

n_q1 <- data_q1 %>% nrow()
data_list_q1 <-
  c(list(n = n_q1), as.list(data_q1))
data_list_q1
```

```{r idx_first_censor_by_type_q1, include=F, echo=F}
idx_first_censor_by_type_q1 <-
  data_q1 %>% 
  filter(is.na(times)) %>% 
  group_by(type) %>% 
  filter(idx_type == first(idx_type)) %>% 
  ungroup()
idx_first_censor_by_type_q1 
```

```{r data_q1-debug, echo=F, include=F, eval=F}
# # Check that both of these have only one row
# data_q1 %>%  filter(censor == 1) %>% count(is_not_na = times <= 0)
# data_q1 %>% filter(censor > 1) %>% count(is_na = is.na(times))
```

```{r data_list_q1-datapasta, echo=F, include=F, eval=F}
# data_list_q1$type %>% datapasta::vector_paste()
# data_list_q1$times %>% datapasta::vector_paste()
# data_list_q1$censor %>% datapasta::vector_paste()
```

```{r res_sim_q1-setup, include=F, echo=F}
inits_q1 <-  function() {
  list(v = 1, beta0 = 0, beta1 = 0)
}

params_q1 <-
  c(
    paste0('beta', 0:1),
    paste0('median', 0:1),
    'v',
    'S',
    'f',
    'h'
  )
```

```{r res_sim_q1, include=F, echo=F, eval=eval_model_q1}
# res_sim_q1 <-
#   R2OpenBUGS::bugs(
#     # debug = TRUE,
#     data = data_list_q1,
#     inits = inits_q1,
#     model.file = path_model_q1,
#     parameters.to.save = params_q1,
#     DIC = FALSE,
#     n.chains = 1,
#     # n.iter = 50000,
#     n.iter = 10000,
#     n.burnin = 1000
#   )
```

```{r res_sim_q1_export, include=F, echo=F, eval=eval_model_q1}
# write_rds(res_sim_q1, path_res_sim_q1)
```

```{r res_sim_q1_import, include=F, echo=F}
# res_sim_q1 <- read_rds(path_res_sim_q1)
```

```{r res_sim_q1_summ-r2openbugs, include=F, echo=F, eval=F}
# res_sim_q1$summary
```

Below is the model code. Note the following.

+ The model code is very similar to that from the "gastric.odc" example from lecture. Notably, we use a Weibull prior for `times`. (Well, really, since we define the initial value `v = 1`, it is initially equivalent to an exponential distribution.)
+ The regression here is a Poisson regression.
+ The data is modified to be in a workable format for OpenBUGs. Specifically, the `times` values corresponding to censored observations (i.e. `censor = 1`) are re-defined as `NA`, and the `censor` values for these observations are re-defined to the `times` values (and, otherwise, left as 0).

```{r model_q1-show, echo=F}
model_q1
```

```{r res_sim_output_manual_q1, include=F, echo=F}
path_res_sim_output_manual_q1 <- 'q1-output.xlsx'
res_sim_output_manual_q1 <- 
  path_res_sim_output_manual_q1 %>% 
  readxl::read_excel()
res_sim_output_manual_q1
```

Below is a summary of the output, truncated because there are lots of monitored parameters.

```{r res_sim_summ_q1, include=F, echo=F}
var_lvls_q1 <-
  c(
    paste0('beta', 0:1),
    paste0('median', 0:1),
    'v',
    'deviance',
    sprintf('%s[%s]', 'S', 1:n_q1),
    sprintf('%s[%s]', 'f', 1:n_q1),
    sprintf('%s[%s]', 'h', 1:n_q1)
  )

res_sim_summ_q1 <-
  res_sim_output_manual_q1 %>% 
  # Re-order these.
  mutate_at(vars(var), ~factor(., levels = var_lvls_q1)) %>% 
  arrange(var) %>% 
  # Then re-coerce var back to its original data type.
  mutate_at(vars(var), as.character)
res_sim_summ_q1
```

```{r res_sim_summ_q1-show}
res_sim_summ_q1
```

```{r res_sim_summ_q1_filt, include=F, echo=F}
.n_show_trunc_q1 <- 5
.idx_start2_q1 <- 53
.idx_1_q1 <- 1:.n_show_trunc_q1
.idx_2_q1 <- .idx_start2_q1:(.idx_start2_q1 + .n_show_trunc_q1)
vars_filt_q1 <-
  c(
    var_lvls_q1[1:6],
    sprintf('%s[%s]', 'S', .idx_1_q1),
    sprintf('%s[%s]', 'S', .idx_2_q1),
    sprintf('%s[%s]', 'f', .idx_1_q1),
    sprintf('%s[%s]', 'h', .idx_1_q1)
  )
vars_filt_q1

res_sim_summ_filt_q1 <-
  res_sim_summ_q1 %>% 
  filter(var %in% vars_filt_q1)
res_sim_summ_filt_q1
```

```{r credible_set_q1, include=F, echo=F}
beta1_q1 <- res_sim_summ_filt_q1 %>% filter(var == 'beta1')
beta1_q1
beta1_mean_q1 <- beta1_q1 %>% pull(mean)
beta1_mean_q1
beta1_mean_chr_q1 <- beta1_mean_q1 %>% format_num()
beta1_mean_chr_q1
credible_set_q1 <- c(beta1_q1$val2.5pc, beta1_q1$val97.5pc)
credible_set_q1
credible_set_chr_q1 <- credible_set_q1 %>% format_num()
credible_set_chr_q1
```


From the output shown above, we see that the posterior mean for `beta1` is `r beta1_mean_chr_q1`, <response>and we see that 95% credible set for `beta1` is [`r credible_set_chr_q1[1]`, `r credible_set_chr_q1[2]`].</response>

### Aside: A Closer Evaluation

Below is a subset of the results. Shown are:

1. All of the "non-array" monitored parameters (including deviance);
2. The first `r .n_show_trunc_q1` estimates of each "array" monitored parameters;
3. The first `r .n_show_trunc_q1` of the second group of `S` monitored parameters.

```{r res_sim_summ_filt_q1-show-pre, include=F, echo=F}
opt_tibble_print_min <- getOption('tibble.print_min')
n_res_sim_summ_filt_q1 <- res_sim_summ_filt_q1 %>% nrow()
options(tibble.print_min = n_res_sim_summ_filt_q1)
```

```{r res_sim_summ_filt_q1-show}
res_sim_summ_filt_q1
```

```{r res_sim_summ_filt_q1-show-post, include=F, echo=F}
options(tibble.print_min = opt_tibble_print_min)
```

```{r res_sim_summ_filt_s_q1, include=F, echo=F}
res_sim_summ_filt_s_q1 <-
  res_sim_summ_q1 %>% 
  filter(var %>% str_detect('^S')) %>% 
  mutate(idx = row_number()) %>% 
  inner_join(data_q1) %>% 
  mutate_at(vars(type), as.factor) %>% 
  select(type, idx, idx_type, everything())
res_sim_summ_filt_s_q1
```

```{r viz-funcs, include=F, echo=F}
theme_custom <- function(...) {
  theme_light(base_size = 14) +
    theme(
      legend.position = 'bottom',
      # legend.title = element_blank(),
      axis.title.x = element_text(hjust = 1),
      axis.title.y = element_text(hjust = 1),
      ...
    )
}

export_png <-
  function(x,
           path,
           ...,
           units = 'in',
           width = 8,
           height = 5) {
    ggsave(
      plot = x,
      filename = path,
      units = units,
      width = width,
      height = height,
      ...
    )
  }
```

Below is a plot of the survival curves corresponding to the two types of tumors (1 for aneuploid tumor, 2 for diploid tumor).

```{r path_viz_s_q1, include=F, echo=F}
path_viz_s_q1 <- 'viz_s_q1.png'
eval_viz_s_q1 <- !fs::file_exists(path_viz_s_q1)
```

```{r viz_s_q1, include=F, echo=F, fig.show=F}
idx_first_censor_by_type_q1 %>% 
  mutate_at(vars(type), as.factor) %>% 
  inner_join(res_sim_summ_filt_s_q1)
  
viz_s_q1 <-
  res_sim_summ_filt_s_q1 %>% 
  ggplot() +
  aes(x = idx_type, y = mean, color = type) +
  geom_line(size = 1.5) +
  geom_point(
    data = 
      idx_first_censor_by_type_q1 %>% 
      mutate_at(vars(type), as.factor) %>% 
      inner_join(res_sim_summ_filt_s_q1),
    size = 5
  ) + 
  guides(color = guide_legend(title = 'Tumor Type', override.aes = list(size = 3))) +
  scale_color_manual(values = c('red', 'blue')) +
  theme_custom() +
  labs(
    subtitle = 'Survival Probability',
    caption = 'First censored data points shown as points.',
    x = 'Index of Observation',
    y = 'Posterior Mean of Survival Probability'
  )
viz_s_q1
```

```{r viz_s_q1_export, include=F, echo=F, eval=eval_viz_s_q1}
export_png(
  viz_s_q1,
  path = path_viz_s_q1,
)
```

```{r viz_s_q1-show, include=T, echo=F}
knitr::include_graphics(path_viz_s_q1)
```


# 2. Airfreight Breakage with Missing Data..

## Instructions

<instructions>
A substance used in...
</instructions>


## Response


```{r q2-0}
x <- c(2, 1, 0, 2, NA_integer_, 3, 1, 0, 1, 2, 3, 0, 1, NA_integer_, NA_integer_)
y <- c(NA_integer_, 16, 9, 17, 12, 22, 13, 8, NA_integer_, 19, 17, 11, 10, 20, 2)
```

```{r path_res_sim_q2, include=F, echo=F}
path_res_sim_q2 <- 'path_res_sim_q2.rds'
eval_model_q2 <- !fs::file_exists(path_res_sim_q2)
```

```{r model_q2, include=F, echo=F}
model_q2 <- glue::glue_collapse('
  model {	
    for(i in 1:n) {
      y[i] ~ dpois(mu[i])
      log(mu[i]) <- beta0 + beta1 * log(x[i])
    }	
    beta0 ~ dnorm(0, 0.0001)
    beta1 ~ dnorm(0, 0.0001)
  }
')

path_model_q2 <- 'model_q2.txt'
write_lines(model_q1, path_model_q2)
```

```{r data_list_q2, include=F, echo=F}
data_raw_q2 <- 
  tibble(
    x = x,
    y = y
  )

data_q2 <-
  data_raw_q2 %>% 
  mutate(x_dummy = x, y_dummy = y) %>% 
  mutate_at(vars(y_dummy), 

n_q2 <- data_q2 %>% nrow()
data_list_q2 <-
  c(list(n = n_q2), as.list(data_q2))
data_list_q1
```

```{r data_list_q2-datapasta, echo=F, include=F, eval=F}
# data_list_q2$type %>% datapasta::vector_paste()
# data_list_q2$times %>% datapasta::vector_paste()
# data_list_q2$censor %>% datapasta::vector_paste()
```

```{r res_sim_q2-setup, include=F, echo=F}
inits_q2 <-  function() {
  list(v = 1, beta0 = 0, betq2 = 0)
}

params_q2 <-
  c(
    paste0('beta', 0:1),
    paste0('median', 0:1),
    'v',
    'S',
    'f',
    'h'
  )
```

```{r res_sim_q2, include=F, echo=F, eval=eval_model_q2}
# res_sim_q2 <-
#   R2OpenBUGS::bugs(
#     # debug = TRUE,
#     data = data_list_q2,
#     inits = inits_q2,
#     model.file = path_model_q2,
#     parameters.to.save = params_q2,
#     DIC = FALSE,
#     n.chains = 1,
#     # n.iter = 50000,
#     n.iter = 10000,
#     n.burnin = 1000
#   )
```




```{r fit_pois}
set.seed(42)
data <-
  tibble(x = x, y = y) %>% 
  mutate_at(
    vars(x), 
    list(x_impute = ~case_when(
      is.na(.) ~ runif(1, 0, 3),
      TRUE ~ .
    ))
  ) %>% 
  mutate_all(as.integer)
data

fit_pois_impute <- 
  data %>% 
  glm(formula(y ~ x_impute), family = 'poisson', data = .)
fit_pois_impute

fit_pois_miss <- 
  data %>% 
  glm(formula(y ~ x), family = 'poisson', data = .)
fit_pois_miss
```

